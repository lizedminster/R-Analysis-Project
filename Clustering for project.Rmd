

```{r}
library(NbClust)
library(mclust)
library(flexclust)
library(cluster)
library(fpc)
library(knitr)
library(rattle)
library(dplyr)
library(stats)
library(factoextra)
library(ggplot2)
```


```{r}
#testing
# Read in library data for 2021
lib_data_21 <- read.csv("C:/Users/sevan/OneDrive/School Work/Semester 6/INFO 248/Project/2021/PLS_FY2021 PUD_CSV/21.csv")

# Read in library data for 2011
lib_data_11 <- read.csv("C:/Users/sevan/OneDrive/School Work/Semester 6/INFO 248/Project/2011/pupld11b.csv")
```

```{r}
# Combining physical and downloadable copies of audio books into one column called Total_Audio_Books
lib_data_21$Total_Audio_Books <- lib_data_21$AUDIO_PH + lib_data_21$AUDIO_DL
# Combining physical and downloadable copies of videos into one column called Total_Videos
lib_data_21$Total_Videos <- lib_data_21$VIDEO_PH + lib_data_21$VIDEO_DL

# Combining physical and downloadable copies of audio books into one column called Total_Audio_Books
lib_data_11$Total_Audio_Books <- lib_data_11$AUDIO_PH + lib_data_11$AUDIO_DL
# Combining physical and downloadable copies of videos into one column called Total_Videos
lib_data_11$Total_Videos <- lib_data_11$VIDEO_PH + lib_data_11$VIDEO_DL
```

```{r}
# Selecting the specific columns needed for clustering analysis
variables_21 <- lib_data_21[, c("OBEREG", "LIBRARIA", "BKVOL", "EBOOK", "Total_Audio_Books", "Total_Videos", "REGBOR", "VISITS")]

# Selecting the specific columns needed for clustering analysis 
# Web visits was included in orginal clustering for the 2021 data, however that variable doesn't exist in the 2011 data therefore it's been removed from both
variables_11 <- lib_data_11[, c("OBEREG", "LIBRARIA", "BKVOL", "EBOOK", "Total_Audio_Books", "Total_Videos", "REGBOR", "VISITS")]
```


```{r}
variables_21 <- variables_21[which(variables_21$OBEREG != 9),]
variables_11 <- variables_11[which(variables_11$OBEREG != 9),]
```

```{r}
# Changing all instances of  placeholder values that denote missing data, temporarily closed, suppressed data, or not applicable into NAs
variables_21[variables_21 < 0] <- NA

# Removing all NAs from the data
variables_21 <- na.omit(variables_21)

# Changing all instances of  placeholder values that denote missing data, temporarily closed, suppressed data, or not applicable into NAs
variables_11[variables_11 < 0] <- NA

# Removing all NAs from the data
variables_11 <- na.omit(variables_11)
```


```{r}
# Histograms of all numeric variables being used to visualize the distribution of values
par(mfrow = c(1,2))
for (col in names(variables_21)) {
  hist(variables_21[[col]], main = paste("2021 - ", col ))
  hist(variables_11[[col]], main = paste("2011 - ", col))
}
```



```{r}
# Removing outlier in all numeric variables, make a function to run different data through

#cleaned_data_21 <- variables_21

remover_outliers <- function(data) {
  
  rows_to_remove <- integer(0)
  
  for (col in names(data)[-c(1)]) {
    q1 <- quantile(data[[col]], 0.25,)
    q3 <- quantile(data[[col]], 0.75,)
    
    iqr <- q3 - q1
    
    lower_bound <- q1 - 1.5 * iqr
    upper_bound <- q3 + 0.75 * iqr
  
    outlier_rows <- which(data[[col]] < lower_bound | data[[col]] > upper_bound)
    
    rows_to_remove <- union(rows_to_remove, outlier_rows)
  }
  
  rows_to_remove <- unique(rows_to_remove)
  cleaned_data <- data[-rows_to_remove, ]
  
  return(cleaned_data)
}
```


```{r}
cleaned_data_21 <- remover_outliers(variables_21)
cleaned_data_11 <- remover_outliers(variables_11)

par(mfrow = c(1,2))

for (col in names(cleaned_data_21)) {
  hist(cleaned_data_21[[col]], main = paste("2021 - ", col ))
  hist(cleaned_data_11[[col]], main = paste("2011 - ", col))
}
```


```{r}
def.tbl <- table(cleaned_data_21$OBEREG)
kable(def.tbl, col.names = c("Condition", "Frequency"), caption='Number of Libraries in Each Region - 2021')

def.tbl <- table(cleaned_data_11$OBEREG)
kable(def.tbl, col.names = c("Condition", "Frequency"), caption='Number of Libraries in Each Region - 2011')
```


```{r}
cleaned_data_21.scaled <- scale(cleaned_data_21[-1])
cleaned_data_11.scaled <- scale(cleaned_data_11[-1])
```

```{r}
wssplot <- function(data, nc=15, seed=1234){
               wss <- (nrow(data)-1)*sum(apply(data,2,var))
               for (i in 2:nc){
                    set.seed(seed)
                    wss[i] <- sum(kmeans(data, centers=i)$withinss)}
                plot(1:nc, wss, type="b", xlab="Number of Clusters",
                     ylab="Within groups sum of squares")
           }
```


```{r}
wssplot(cleaned_data_21.scaled)
wssplot(cleaned_data_11.scaled)
```


```{r}
RNGversion("4.1.2")
set.seed(1234)
fit.km5 <- kmeans(cleaned_data_21.scaled, 5, nstart=25)
fit.km5$tot.withinss

RNGversion("4.1.2")
set.seed(1234)
fit.km4 <- kmeans(cleaned_data_11.scaled, 4, nstart=25)
fit.km4$tot.withinss
```

```{r}
plotcluster(cleaned_data_21.scaled, fit.km5$cluster)
plotcluster(cleaned_data_11.scaled, fit.km4$cluster)
```

```{r}
# BIC estimates the likeihood of a model to predict


model.clus_21 <- Mclust(cleaned_data_21.scaled)
summary(model.clus_21)

model.clus_11 <- Mclust(cleaned_data_11.scaled)
summary(model.clus_11)
```


```{r}
randIndex(table(model.clus_21$classification, cleaned_data_21$OBEREG))
mc_21.tbl <- table(model.clus_21$classification, cleaned_data_21$OBEREG)
mc_21.tbl

randIndex(table(model.clus_11$classification, cleaned_data_11$OBEREG))
mc_11.tbl <- table(model.clus_11$classification, cleaned_data_11$OBEREG)
mc_11.tbl
```

```{r}
chisq.test(mc_21.tbl)
chisq.test(mc_11.tbl)
```

```{r}
plot(model.clus_21, data= cleaned_data_21.scaled, what="BIC")
plot(model.clus_11, data=cleaned_data_11.scaled, what="BIC")
```


```{r}
model.dr <- MclustDR(model.clus_21)
plot(model.dr, what = "contour")

model.dr_cleaned <- MclustDR(model.clus_11)
plot(model.dr_cleaned, what = "contour")
```